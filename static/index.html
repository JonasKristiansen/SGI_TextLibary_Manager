<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chat • SAP AI Deployment</title>
    <style>
      :root { color-scheme: light dark; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; display: grid; grid-template-rows: 1fr auto; height: 100dvh; }
      header { padding: 12px 16px; border-bottom: 1px solid #ddd; font-weight: 600; }
      #chat { padding: 16px; overflow: auto; }
      #similar { border-top: 1px solid #ddd; padding: 10px 16px; background: #fafafa; }
      #similar h3 { margin: 6px 0 8px; font-size: 14px; }
      #sim { margin: 0; padding-left: 18px; }
      .msg { max-width: 800px; margin: 6px 0; padding: 10px 12px; border-radius: 10px; white-space: pre-wrap; }
      .user { background: #e8f0fe; margin-left: auto; }
      .bot { background: #f1f3f4; margin-right: auto; }
      form { display: flex; gap: 8px; padding: 12px; border-top: 1px solid #ddd; }
      textarea { flex: 1; resize: vertical; min-height: 44px; max-height: 160px; padding: 10px; }
      button { padding: 10px 14px; }
      .hint { color: #777; font-size: 12px; padding-left: 4px; }
    </style>
  </head>
  <body>
    <header>Chat • SAP AI Deployment</header>
    <main id="chat"></main>
    <aside id="similar">
      <h3>Similar candidates (top 10)</h3>
      <ol id="sim"></ol>
      <div class="hint">Shown before sending the message to the model.</div>
    </aside>
    <form id="f">
      <textarea id="t" placeholder="Type a message and press Enter…"></textarea>
      <button type="submit">Send</button>
    </form>
    <script>
      const chat = document.getElementById('chat');
      const form = document.getElementById('f');
      const t = document.getElementById('t');
      const simList = document.getElementById('sim');

      function add(role, text){
        const div = document.createElement('div');
        div.className = `msg ${role==='user' ? 'user':'bot'}`;
        div.textContent = text;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
      }

      async function send(message){
        add('user', message);
        t.value = '';
        // 1) find similar library entries
        const sim = await fetch('/api/similar', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({query: message, limit: 10})});
        let similarTexts = [];
        if (sim.ok){
          const arr = await sim.json();
          // render list in the UI
          simList.innerHTML = '';
          arr.forEach((x, idx)=>{
            const li = document.createElement('li');
            li.textContent = `[${x.id}] ${x.text}`;
            simList.appendChild(li);
          });
          similarTexts = arr.map((x, idx) => `${idx+1}. [${x.id}] ${x.text}`).join('\n');
        }
        // 2) build an instruction to check for duplicates and rank top 3
        const instruction = similarTexts ? `You are given a user intent and a candidate list of existing texts.\n\nUser intent:\n${message}\n\nCandidates (with IDs):\n${similarTexts}\n\nTask: Select up to the top 3 candidates that best match the intent in meaning.\nReturn ONLY a numbered list 1-3 in this exact format: \n1. [<ID>] <text> — short reason\n2. [<ID>] <text> — short reason\n3. [<ID>] <text> — short reason\nIf none are good, return exactly: No exact match.\nKeep total under 60 words.` : message;
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: instruction })
        });
        if(!res.ok){
          const err = await res.text();
          add('bot', `Error ${res.status}: ${err}`);
          return;
        }
        const payload = await res.json();
        // Try to pick assistant text from various provider response shapes
        let text = '';
        try {
          if(payload?.content?.length && payload.content[0].text){
            text = payload.content[0].text;
          } else if(payload?.choices?.length){
            const m = payload.choices[0].message || payload.choices[0].delta;
            text = (m?.content) || JSON.stringify(payload);
          } else {
            text = JSON.stringify(payload);
          }
        } catch(e){ text = JSON.stringify(payload); }
        add('bot', text);
      }

      form.addEventListener('submit', e => {
        e.preventDefault();
        const msg = t.value.trim();
        if(msg) send(msg);
      });

      // Enter to send
      t.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' && !e.shiftKey){
          e.preventDefault();
          form.requestSubmit();
        }
      });
    </script>
  </body>
  </html>


